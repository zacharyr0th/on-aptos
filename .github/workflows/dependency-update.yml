name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update dependencies
        run: |
          # Update non-major versions
          pnpm update --latest --interactive false
          
          # Check for major updates
          pnpm outdated > outdated.txt || true

      - name: Run tests after update
        run: |
          pnpm test:run
          pnpm build
        env:
          NEXT_PUBLIC_SITE_URL: https://on-aptos.com

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet package.json pnpm-lock.yaml; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'ðŸ”„ Automated Dependency Updates'
          body: |
            ## ðŸ”„ Automated Dependency Updates
            
            This PR contains automated dependency updates.
            
            ### Changes
            - Updated non-breaking dependency versions
            - All tests passing âœ…
            - Build successful âœ…
            
            ### Review Required
            Please review the changes and test thoroughly before merging.
            
            ### Major Updates Available
            ```
            $(cat outdated.txt || echo "No major updates available")
            ```
            
            ---
            _This PR was created automatically by the dependency update workflow._
          branch: chore/dependency-updates
          delete-branch: true

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '9'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          # Run npm audit and capture output
          pnpm audit --json > audit-results.json || true
          
          # Parse and format results
          VULNERABILITIES=$(cat audit-results.json | jq -r '.vulnerabilities | length')
          
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "ðŸš¨ Security vulnerabilities found: $VULNERABILITIES"
            cat audit-results.json | jq '.vulnerabilities'
          else
            echo "âœ… No security vulnerabilities found"
          fi

      - name: Create security issue
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let auditResults = '';
            
            try {
              auditResults = fs.readFileSync('audit-results.json', 'utf8');
              const audit = JSON.parse(auditResults);
              const vulnCount = Object.keys(audit.vulnerabilities || {}).length;
              
              if (vulnCount > 0) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸš¨ Security Alert: ${vulnCount} vulnerabilities found`,
                  body: `## Security Audit Alert
                  
                  **Vulnerabilities Found:** ${vulnCount}
                  
                  \`\`\`json
                  ${JSON.stringify(audit.vulnerabilities, null, 2)}
                  \`\`\`
                  
                  **Action Required:**
                  1. Review the vulnerabilities above
                  2. Update affected packages
                  3. Test the application thoroughly
                  4. Close this issue once resolved
                  
                  ---
                  _This issue was created automatically by the security audit workflow._`,
                  labels: ['security', 'urgent']
                });
              }
            } catch (error) {
              console.log('No security issues to report');
            }